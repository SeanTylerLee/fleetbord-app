
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Dispatch</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
</head>
<body>
  <header class="ios-header-image">
    <img src="header.jpg" alt="Header" />
  </header>

  <div class="container" style="padding: 20px;">
    <h2 style="text-align:center;">Dispatch Center</h2>

    <div id="adminDispatchForm" style="display:none;">
      <h3>Create Dispatch</h3>
      <form id="dispatchForm">
        <input type="text" id="pickup" placeholder="Pickup Location" required />
        <input type="text" id="delivery" placeholder="Delivery Location" required />
        <input type="text" id="rate" placeholder="Rate" />
        <textarea id="notes" placeholder="Notes (optional)"></textarea>
        <label>Select Drivers:</label>
        <div id="userCheckboxes"></div>
        <button type="submit">Send Dispatch</button>
      </form>
    </div>

    <div id="dispatchList"></div>
    <a class="ios-item" href="index.html">← Back to Home</a>
  </div>

  <script>
    const currentUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
    const allDispatches = JSON.parse(localStorage.getItem("dispatches") || "[]");
    const dispatchList = document.getElementById("dispatchList");

    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const form = document.getElementById("dispatchForm");

    if (currentUser.role === "admin") {
      document.getElementById("adminDispatchForm").style.display = "block";
      const userBox = document.getElementById("userCheckboxes");
      users.forEach(user => {
        if (user.role === "driver") {
          const label = document.createElement("label");
          label.innerHTML = `<input type="checkbox" value="${user.username}" /> ${user.username}`;
          userBox.appendChild(label);
          userBox.appendChild(document.createElement("br"));
        }
      });
    }

    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const selectedDrivers = Array.from(document.querySelectorAll("#userCheckboxes input:checked")).map(cb => cb.value);
        if (selectedDrivers.length === 0) return alert("Select at least one driver.");
        const newDispatch = {
          id: Date.now(),
          pickup: form.pickup.value,
          delivery: form.delivery.value,
          rate: form.rate.value,
          notes: form.notes.value,
          assignedTo: selectedDrivers,
          acceptedBy: []
        };
        allDispatches.push(newDispatch);
        localStorage.setItem("dispatches", JSON.stringify(allDispatches));
        form.reset();
        renderDispatches();
      });
    }

    function renderDispatches() {
      dispatchList.innerHTML = "";
      const filtered = allDispatches.filter(d =>
        currentUser.role === "admin" || d.assignedTo.includes(currentUser.username)
      );

      if (filtered.length === 0) {
        dispatchList.innerHTML = "<p>No dispatches available.</p>";
        return;
      }

      filtered.forEach(d => {
        const div = document.createElement("div");
        div.className = "dispatch-entry";
        div.innerHTML = `
          <strong>Pickup:</strong> ${d.pickup}<br>
          <strong>Delivery:</strong> ${d.delivery}<br>
          <strong>Rate:</strong> ${d.rate}<br>
          <strong>Notes:</strong> ${d.notes}<br>
          <strong>Assigned To:</strong> ${d.assignedTo.join(", ")}<br>
          <strong>Accepted By:</strong> ${d.acceptedBy.length ? d.acceptedBy.join(", ") : "None"}<br>
        `;

        if (currentUser.role === "driver" && d.assignedTo.includes(currentUser.username) && !d.acceptedBy.includes(currentUser.username)) {
          const btn = document.createElement("button");
          btn.textContent = "✅ Accept Load";
          btn.onclick = () => {
            d.acceptedBy.push(currentUser.username);
            localStorage.setItem("dispatches", JSON.stringify(allDispatches));
            renderDispatches();
          };
          div.appendChild(btn);
        }

        dispatchList.appendChild(div);
      });
    }

    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark-mode");
    }

    renderDispatches();
  </script>
</body>
</html>
