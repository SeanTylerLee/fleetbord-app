<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleetbord</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: #f2f2f7;
      color: #000;
    }
    header, main {
      padding: 1em;
      max-width: 600px;
      margin: auto;
    }
    h1 { text-align: center; }
    input, button, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      background-color: #007aff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #005bb5;
    }
    .hidden { display: none; }
    .message, .load {
      background: white;
      padding: 10px;
      border-radius: 10px;
      margin-top: 10px;
    }
    nav {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <header>
    <h1>Fleetbord</h1>
    <div id="loginSection">
      <input type="text" id="loginUser" placeholder="Username" />
      <input type="password" id="loginPass" placeholder="Password" />
      <button onclick="login()">Login</button>
    </div>
    <div id="roleLabel" class="hidden">
      Logged in as <strong><span id="roleUser"></span></strong>
      <button onclick="logout()">Logout</button>
    </div>
  </header>

  <main id="app" class="hidden">
    <nav id="adminPanel" class="hidden">
      <button onclick="showSection('manageUsers')">Manage Users</button>
    </nav>

    <div id="manageUsers" class="hidden">
      <h2>User Management</h2>
      <input type="text" id="newUser" placeholder="Username">
      <input type="password" id="newPass" placeholder="Password">
      <select id="newRole">
        <option value="driver">Driver</option>
        <option value="dispatcher">Dispatcher</option>
        <option value="office">Office</option>
      </select>
      <button onclick="createUser()">Create User</button>
      <div id="userList"></div>
    </div>

    <div id="messaging">
      <h2>Messaging</h2>
      <select id="recipientSelect" multiple></select>
      <textarea id="messageInput" placeholder="Type message..."></textarea>
      <input type="file" id="messageImage">
      <button onclick="sendMessage()">Send</button>
      <div id="messagesDiv"></div>
    </div>

    <div id="loads">
      <h2>Load Records</h2>
      <input type="date" id="loadDate">
      <input type="text" id="ticketNum" placeholder="Ticket Number">
      <input type="text" id="customer" placeholder="Customer">
      <input type="text" id="rig" placeholder="Rig">
      <input type="text" id="lease" placeholder="Lease">
      <input type="number" id="price" placeholder="Price">
      <input type="number" id="overnights" placeholder="Overnights">
      <input type="file" id="loadPhoto" multiple>
      <button onclick="saveLoad()">Save Load</button>
      <div id="loadList"></div>
      <button onclick="generatePaySheet()">Generate Pay Sheet CSV</button>
    </div>
  </main>

  <script>
    const users = {
      Sean: { password: "1", role: "admin" }
    };

    let currentUser = null;

    function login() {
      const u = loginUser.value;
      const p = loginPass.value;
      if (users[u] && users[u].password === p) {
        currentUser = { username: u, role: users[u].role };
        roleUser.textContent = `${u} (${users[u].role})`;
        document.getElementById('loginSection').classList.add("hidden");
        document.getElementById('roleLabel').classList.remove("hidden");
        document.getElementById('app').classList.remove("hidden");
        if (["admin", "office"].includes(users[u].role)) {
          adminPanel.classList.remove("hidden");
        }
        populateUsers();
      } else {
        alert("Invalid credentials");
      }
    }

    function logout() {
      location.reload();
    }

    function showSection(id) {
      document.querySelectorAll("main > div").forEach(el => el.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    function createUser() {
      const u = newUser.value.trim();
      const p = newPass.value.trim();
      const r = newRole.value;
      if (u && p && !users[u]) {
        users[u] = { password: p, role: r };
        alert("User created!");
        populateUsers();
      } else {
        alert("Invalid or existing username");
      }
    }

    function populateUsers() {
      recipientSelect.innerHTML = "";
      userList.innerHTML = "";
      Object.keys(users).forEach(u => {
        const { role } = users[u];
        if (u !== currentUser?.username) {
          const opt = document.createElement("option");
          opt.value = u;
          opt.textContent = `${u} (${role})`;
          recipientSelect.appendChild(opt);
        }
        if (["admin", "office"].includes(currentUser?.role)) {
          const div = document.createElement("div");
          div.textContent = `${u} (${role})`;
          userList.appendChild(div);
        }
      });
    }

    const messages = [];

    function sendMessage() {
      const text = messageInput.value;
      const to = [...recipientSelect.selectedOptions].map(opt => opt.value);
      const file = messageImage.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        messages.push({ from: currentUser.username, to, text, image: reader.result });
        displayMessages();
      };
      if (file) reader.readAsDataURL(file);
      else {
        messages.push({ from: currentUser.username, to, text });
        displayMessages();
      }
    }

    function displayMessages() {
      messagesDiv.innerHTML = "";
      messages.forEach(m => {
        if (m.to.includes(currentUser.username) || m.from === currentUser.username || currentUser.role === 'dispatcher') {
          const div = document.createElement("div");
          div.className = "message";
          div.innerHTML = `<strong>${m.from}:</strong> ${m.text || ''}`;
          if (m.image) {
            const img = document.createElement("img");
            img.src = m.image;
            img.style.maxWidth = "100%";
            div.appendChild(img);
          }
          messagesDiv.appendChild(div);
        }
      });
    }

    const loads = [];

    function saveLoad() {
      const load = {
        user: currentUser.username,
        date: loadDate.value,
        ticket: ticketNum.value,
        customer: customer.value,
        rig: rig.value,
        lease: lease.value,
        price: price.value,
        overnights: overnights.value,
        photos: []
      };

      const files = loadPhoto.files;
      const promises = Array.from(files).map(file => {
        return new Promise(res => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.readAsDataURL(file);
        });
      });

      Promise.all(promises).then(imgs => {
        load.photos = imgs;
        loads.push(load);
        displayLoads();
      });
    }

    function displayLoads() {
      loadList.innerHTML = "";
      loads.filter(l => l.user === currentUser.username || currentUser.role !== 'driver')
        .forEach((l, i) => {
        const div = document.createElement("div");
        div.className = "load";
        div.innerHTML = `<strong>${l.date}</strong> - ${l.ticket} - $${l.price}<br/>
          <input type="checkbox" data-index="${i}" class="payCheck"/>`;
        loadList.appendChild(div);
      });
    }

    function generatePaySheet() {
      const selected = [...document.querySelectorAll('.payCheck:checked')]
        .map(cb => loads[cb.dataset.index]);
      if (!selected.length) return alert("No loads selected.");

      let content = "Date,Ticket,Customer,Rig,Lease,Price,Overnights\n";
      let total = 0, nights = 0;

      selected.forEach(l => {
        content += `${l.date},${l.ticket},${l.customer},${l.rig},${l.lease},${l.price},${l.overnights}\n`;
        total += parseFloat(l.price || 0);
        nights += parseInt(l.overnights || 0);
      });

      const blob = new Blob([content], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `PaySheet-${currentUser.username}.csv`;
      a.click();
    }
  </script>
</body>
</html>