<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pay Sheet | Fleetbord</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>Pay Sheet</h1>
    <a href="dashboard.html" class="nav-button">‚Üê Back</a>
  </header>

  <main>
    <h2>Select Loads</h2>
    <div id="loadList"></div>

    <button id="exportPdf" class="nav-button" style="margin-top: 1em;">Export to PDF</button>
  </main>

  <script>
    const username = localStorage.getItem('username');
    if (!username) window.location.href = 'index.html';

    const loadList = document.getElementById('loadList');
    const exportBtn = document.getElementById('exportPdf');
    let loads = [];

    async function loadLoads() {
      const res = await fetch('/loads?user=' + username);
      loads = await res.json();
      loadList.innerHTML = loads
        .map(
          (load, idx) => `
        <div style="margin-bottom: 1em; background: var(--card); padding: 1em; border-radius: 0.5em;">
          <input type="checkbox" id="load_${idx}" data-index="${idx}">
          <label for="load_${idx}">
            ${load.date} | Ticket #${load.ticket} | ${load.customer} | $${load.price} | Overnight: ${load.overnights}
          </label>
        </div>`
        )
        .join('');
    }

    exportBtn.onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      let y = 10;
      doc.setFontSize(18);
      doc.text('Fleetbord Pay Sheet', 10, y);
      y += 10;
      doc.setFontSize(12);

      doc.text(`Driver: ${username}`, 10, y);
      y += 10;

      // Headers
      doc.text('Date', 10, y);
      doc.text('Ticket #', 40, y);
      doc.text('Customer', 80, y);
      doc.text('Price', 140, y);
      doc.text('Overnights', 170, y);
      y += 7;

      let totalPrice = 0;
      let totalOvernights = 0;

      loads.forEach((load, idx) => {
        const checkbox = document.getElementById(`load_${idx}`);
        if (checkbox && checkbox.checked) {
          doc.text(load.date, 10, y);
          doc.text(load.ticket.toString(), 40, y);
          doc.text(load.customer, 80, y);
          doc.text(`$${load.price}`, 140, y);
          doc.text(load.overnights.toString(), 170, y);
          y += 7;
          totalPrice += Number(load.price);
          totalOvernights += Number(load.overnights);
        }
      });

      y += 5;
      doc.text('------------------------------', 10, y);
      y += 7;
      doc.text(`Total Price: $${totalPrice.toFixed(2)}`, 10, y);
      y += 7;
      doc.text(`Total Overnights: ${totalOvernights}`, 10, y);

      doc.save(`PaySheet_${username}_${new Date().toISOString().slice(0,10)}.pdf`);
    };

    loadLoads();
  </script>
</body>
</html>