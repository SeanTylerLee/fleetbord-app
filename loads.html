<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Fleetbord - Loads</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Thumbnail style */
    .thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      margin: 4px;
      cursor: pointer;
      border: 1px solid #ccc;
    }

    /* Expanded load styling */
    .load-entry {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Summary clickable area */
    .load-summary {
      cursor: pointer;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      background: #fff;
      border: 1px solid #ccc;
      margin-bottom: 0.5rem;
      user-select: none;
    }

    /* Photo container */
    .attachments {
      display: flex;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    /* Preview modal */
    #previewModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #previewModal img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 0 20px #000;
    }
    #previewModal .close-btn {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 28px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
    }
  </style>
</head>
<script>
  if (!localStorage.getItem('fleetbordLoggedInUser')) {
    window.location.href = 'login.html';
  }
</script>
<body>

  <!-- Top Header -->
  <header>
    <a href="index.html" class="back-button">
      <svg class="back-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 22" fill="none">
        <path d="M11 1L2 11L11 21" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back
    </a>
  </header>

  <!-- Banner -->
  <img src="header.png" alt="Top Banner" class="top-image" />

  <!-- Main Layout -->
  <main>

    <!-- Add Load -->
    <div class="card">
      <h2>Add Load</h2>
      <form id="loadForm" class="form-list">
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label for="ticket">Ticket Number</label>
          <input type="text" id="ticket" placeholder="Ticket Number" required />
        </div>
        <div>
          <label for="customer">Customer</label>
          <input type="text" id="customer" placeholder="Customer" required />
        </div>
        <div>
          <label for="lease">Lease</label>
          <input type="text" id="lease" placeholder="Lease" required />
        </div>
        <div>
          <label for="rig">Rig</label>
          <input type="text" id="rig" placeholder="Rig" required />
        </div>
        <div>
          <label for="rate">Rate</label>
          <input type="number" id="rate" placeholder="Rate" required />
        </div>
        <div>
          <label for="overnights">Overnights</label>
          <input type="number" id="overnights" placeholder="Overnights" required />
        </div>
        <div>
          <label for="photo">Photos</label>
          <input type="file" id="photo" accept="image/*" multiple />
        </div>
        <button type="submit">Save Load</button>
      </form>
    </div>

    <!-- Filters -->
    <div class="card">
      <h2>Filter by Date</h2>
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
      <button onclick="filterByDate()">Apply Filter</button>

      <h2>Filter by Customer</h2>
      <input type="text" id="customerFilter" placeholder="Enter customer name" />
      <button onclick="filterByCustomer()">Apply Customer Filter</button>
    </div>

    <!-- Export Buttons -->
    <div class="card">
      <h2>Selected Loads</h2>
      <button onclick="exportToPDF()">ðŸ“„ Export to PDF</button>
      <button onclick="emailPaySheet()">ðŸ“§ Email Pay Sheet</button>
    </div>

    <!-- Load Entries -->
    <div id="loadList" class="card"></div>

  </main>

  <!-- Bottom Tab Bar -->
  <nav class="tab-bar">
    <a href="index.html" class="tab-button">Home</a>
    <a href="loads.html" class="tab-button active">Loads</a>
    <a href="messages.html" class="tab-button">Messages</a>
    <a href="settings.html" class="tab-button">Settings</a>
  </nav>

  <!-- Image Preview Modal -->
  <div id="previewModal">
    <span class="close-btn" onclick="closePreview()">&times;</span>
    <img id="previewImage" src="" alt="Preview" />
  </div>

  <!-- JS & PDF Script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const form = document.getElementById('loadForm');
    const loadList = document.getElementById('loadList');
    const previewModal = document.getElementById('previewModal');
    const previewImage = document.getElementById('previewImage');

    let loads = JSON.parse(localStorage.getItem('loads') || '[]');

    function renderLoads(filtered = null) {
      loadList.innerHTML = '';
      const displayLoads = filtered || loads;

      if (displayLoads.length === 0) {
        loadList.innerHTML = '<p>No loads yet.</p>';
        return;
      }

      displayLoads.forEach((load, index) => {
        // Container
        const container = document.createElement('div');

        // Summary div: shows date, customer, rate
        const summary = document.createElement('div');
        summary.className = 'load-summary';
        summary.textContent = `${load.date} -- ${load.customer} -- $${load.rate}`;
        summary.onclick = () => toggleExpanded(index);
        container.appendChild(summary);

        // Details div (hidden or shown)
        const details = document.createElement('div');
        details.className = 'load-entry';
        details.style.display = load.expanded ? 'block' : 'none';

        details.innerHTML = `
          <p><strong>Ticket Number:</strong> ${load.ticket}</p>
          <p><strong>Lease:</strong> ${load.lease}</p>
          <p><strong>Rig:</strong> ${load.rig}</p>
          <p><strong>Overnights:</strong> ${load.overnights}</p>
          <button onclick="deleteLoad(${index})" style="margin-bottom:10px;">Delete Load</button>
        `;

        // Photos thumbnails container
        if (load.photos && load.photos.length) {
          const attachmentsDiv = document.createElement('div');
          attachmentsDiv.className = 'attachments';

          load.photos.forEach((photoSrc, i) => {
            const img = document.createElement('img');
            img.src = photoSrc;
            img.alt = `Load photo ${i + 1}`;
            img.className = 'thumbnail';
            img.onclick = () => openPreview(photoSrc);
            attachmentsDiv.appendChild(img);
          });

          details.appendChild(attachmentsDiv);
        }

        container.appendChild(details);
        loadList.appendChild(container);
      });
    }

    function toggleExpanded(index) {
      loads[index].expanded = !loads[index].expanded;
      saveLoads();
      renderLoads();
    }

    function deleteLoad(index) {
      if (confirm('Delete this load?')) {
        loads.splice(index, 1);
        saveLoads();
        renderLoads();
      }
    }

    function saveLoads() {
      localStorage.setItem('loads', JSON.stringify(loads));
    }

    function filterByDate() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      const filtered = loads.filter(load => {
        return (!start || load.date >= start) && (!end || load.date <= end);
      });
      renderLoads(filtered);
    }

    function filterByCustomer() {
      const customerInput = document.getElementById('customerFilter').value.trim().toLowerCase();
      if (!customerInput) {
        renderLoads();
        return;
      }
      const filtered = loads.filter(load => load.customer.toLowerCase().includes(customerInput));
      renderLoads(filtered);
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Fleetbord Pay Sheet", 10, 10);

      let y = 20;
      loads.forEach(load => {
        if (load.selected) {
          doc.text(`${load.date} | ${load.customer} | Ticket: ${load.ticket}`, 10, y);
          y += 10;
        }
      });

      doc.save("PaySheet.pdf");
    }

    function emailPaySheet() {
      const selected = loads.filter(load => load.selected);
      if (!selected.length) {
        alert("No loads selected.");
        return;
      }
      const body = selected.map(load =>
        `${load.date} - ${load.customer} - Ticket ${load.ticket}`
      ).join('\n');

      window.location.href = `mailto:office@example.com?subject=Pay Sheet&body=${encodeURIComponent(body)}`;
    }

    function openPreview(src) {
      previewImage.src = src;
      previewModal.style.display = 'flex';
    }
    function closePreview() {
      previewModal.style.display = 'none';
      previewImage.src = '';
    }
    previewModal.onclick = e => {
      if (e.target === previewModal) closePreview();
    };

    form.addEventListener('submit', e => {
      e.preventDefault();
      const files = document.getElementById('photo').files;
      if (files.length === 0) {
        saveLoad([]);
        return;
      }

      const photos = [];
      let loadedCount = 0;

      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        reader.onload = (event) => {
          photos.push(event.target.result);
          loadedCount++;
          if (loadedCount === files.length) {
            saveLoad(photos);
          }
        };
        reader.readAsDataURL(files[i]);
      }
    });

    function saveLoad(photos) {
      const newLoad = {
        date: form.date.value,
        ticket: form.ticket.value,
        customer: form.customer.value,
        lease: form.lease.value,
        rig: form.rig.value,
        rate: form.rate.value,
        overnights: form.overnights.value,
        photos: photos,
        selected: false,
        expanded: false
      };
      loads.push(newLoad);
      saveLoads();
      form.reset();
      renderLoads();
    }

    renderLoads();
  </script>
</body>
</html>