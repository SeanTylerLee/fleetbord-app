<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FleetBord Admin & User App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 1rem;
      background: #FAF6F2;
      display: flex; justify-content: center;
    }
    .container {
      width: 100%; max-width: 420px;
    }
    .hidden { display: none; }
    input, select, button, textarea {
      margin: 0.4rem 0;
      padding: 0.7rem;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      background: #007AFF; color: white; border: none;
    }
    .panel {
      background: white;
      padding: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    .load-item, .message-item, .user-item {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 0.5rem;
      margin: 0.3rem 0;
      background: #f9f9fc;
    }
    .logout-btn {
      background-color: #e33;
      margin-top: 1rem;
    }
    .user-actions {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.4rem;
    }
    .user-actions button {
      flex: 1;
      font-size: 0.9rem;
      padding: 0.3rem;
    }
    label {
      font-weight: bold;
      margin-top: 0.6rem;
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- LOGIN PANEL -->
    <div id="loginPanel" class="panel">
      <h2>Login</h2>
      <input id="loginUsername" placeholder="Username" autocomplete="username" />
      <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
      <button onclick="login()">Login</button>
      <p id="loginMessage" style="color:red;"></p>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="panel hidden">
      <h2>Admin Dashboard</h2>
      <button onclick="logout()" class="logout-btn">Logout</button>

      <h3>Create New User</h3>
      <input id="newUserName" placeholder="Username" autocomplete="off" />
      <input id="newUserPass" type="password" placeholder="Password" autocomplete="new-password" />
      <label for="newUserRole">Role:</label>
      <select id="newUserRole">
        <option value="Driver">Driver</option>
        <option value="Office">Office</option>
      </select>
      <button onclick="addUser()">Add User</button>
      <p id="userMsg" style="color:green;"></p>

      <h3>Manage Users</h3>
      <div id="userList"></div>
    </div>

    <!-- USER PANEL -->
    <div id="userPanel" class="panel hidden">
      <h2 id="welcomeMsg">Welcome!</h2>
      <button onclick="logout()" class="logout-btn">Logout</button>

      <h3>Load Tracker</h3>
      <input id="ticketNumber" placeholder="Ticket Number" />
      <input id="customer" placeholder="Customer" />
      <input id="rig" placeholder="Rig" />
      <input id="lease" placeholder="Lease" />
      <input id="price" type="number" placeholder="Price" />
      <input id="overnights" type="number" placeholder="Overnights" />
      <button onclick="addLoad()">Add Load</button>

      <h4>Your Loads</h4>
      <div id="loadList"></div>
      <button onclick="generateForm()">Generate Totals Form</button>
      <div id="totalsForm" class="hidden">
        <h4>Form Totals</h4>
        <div id="formDetails"></div>
        <button onclick="sendForm()">Download PDF</button>
      </div>

      <h3>Messaging</h3>
      <select id="recipientSelect" multiple></select>
      <textarea id="messageText" placeholder="Type your message..." rows="4"></textarea>
      <button onclick="sendMessage()">Send Message</button>

      <h4>Inbox</h4>
      <div id="messageList" style="max-height: 200px; overflow-y: auto;"></div>
    </div>
  </div>

<script>
  // Admin credentials hardcoded
  const adminUsername = "Sean";
  const adminPassword = "1";

  // Stored users: username => {password, role}
  let users = JSON.parse(localStorage.getItem("users")) || {};
  // Loads per user: username => array of loads
  let loads = JSON.parse(localStorage.getItem("loads")) || {};
  // Messages array
  let messages = JSON.parse(localStorage.getItem("messages")) || [];

  let currentUser = "";

  // --- LOGIN ---
  function login() {
    const u = document.getElementById("loginUsername").value.trim();
    const p = document.getElementById("loginPassword").value.trim();
    const msg = document.getElementById("loginMessage");

    if(u === adminUsername && p === adminPassword) {
      currentUser = u;
      if (!users[u]) {
        users[u] = { password: p, role: "Admin" };
        localStorage.setItem("users", JSON.stringify(users));
      }
      msg.textContent = "";
      showAdminPanel();
      return;
    }

    if(users[u] && users[u].password === p) {
      currentUser = u;
      msg.textContent = "";
      showUserPanel();
      return;
    }

    msg.textContent = "Invalid username or password.";
  }

  function logout() {
    currentUser = "";
    clearForms();
    showPanel("login");
  }

  function clearForms() {
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("userMsg").textContent = "";
    document.getElementById("ticketNumber").value = "";
    document.getElementById("customer").value = "";
    document.getElementById("rig").value = "";
    document.getElementById("lease").value = "";
    document.getElementById("price").value = "";
    document.getElementById("overnights").value = "";
    document.getElementById("messageText").value = "";
  }

  // --- UI Control ---
  function showPanel(panel) {
    document.getElementById("loginPanel").classList.add("hidden");
    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("userPanel").classList.add("hidden");

    if(panel === "login") document.getElementById("loginPanel").classList.remove("hidden");
    if(panel === "admin") document.getElementById("adminPanel").classList.remove("hidden");
    if(panel === "user") document.getElementById("userPanel").classList.remove("hidden");
  }

  function showAdminPanel() {
    showPanel("admin");
    renderUserList();
  }

  function showUserPanel() {
    showPanel("user");
    document.getElementById("welcomeMsg").textContent = `Welcome, ${currentUser}!`;
    renderLoads();
    renderMessages();
    populateRecipientList();
  }

  // --- USER MANAGEMENT (Admin only) ---
  function addUser() {
    const name = document.getElementById("newUserName").value.trim();
    const pass = document.getElementById("newUserPass").value.trim();
    const role = document.getElementById("newUserRole").value;
    const msg = document.getElementById("userMsg");

    if(!name || !pass) {
      msg.style.color = "red";
      msg.textContent = "Username and password required.";
      return;
    }
    if(users[name]) {
      msg.style.color = "red";
      msg.textContent = "User already exists.";
      return;
    }
    if(name === adminUsername) {
      msg.style.color = "red";
      msg.textContent = "Cannot create another admin.";
      return;
    }

    users[name] = { password: pass, role };
    localStorage.setItem("users", JSON.stringify(users));
    msg.style.color = "green";
    msg.textContent = `User "${name}" added successfully.`;
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    renderUserList();
  }

  function renderUserList() {
    const container = document.getElementById("userList");
    container.innerHTML = "";

    const ul = document.createElement("ul");
    for(const username in users) {
      if(username === adminUsername) continue;
      const user = users[username];
      const li = document.createElement("li");
      li.className = "user-item";
      li.innerHTML = `
        <strong>${username}</strong> (${user.role})
        <div class="user-actions">
          <button onclick="deleteUser('${username}')">Delete</button>
        </div>
      `;
      ul.appendChild(li);
    }
    if(ul.children.length === 0) {
      container.textContent = "No users yet.";
    } else {
      container.appendChild(ul);
    }
  }

  function deleteUser(username) {
    if(confirm(\`Delete user "\${username}"?\`)) {
      delete users[username];
      localStorage.setItem("users", JSON.stringify(users));
      renderUserList();
    }
  }

  // --- LOAD TRACKING (Users) ---
  function addLoad() {
    const t = document.getElementById("ticketNumber").value.trim();
    const c = document.getElementById("customer").value.trim();
    const r = document.getElementById("rig").value.trim();
    const l = document.getElementById("lease").value.trim();
    const p = parseFloat(document.getElementById("price").value.trim()) || 0;
    const o = parseInt(document.getElementById("overnights").value.trim()) || 0;

    if(!t || !c) {
      alert("Ticket Number and Customer are required.");
      return;
    }
    if(!loads[currentUser]) loads[currentUser] = [];

    loads[currentUser].push({ id: Date.now(), t, c, r, l, p, o });
    localStorage.setItem("loads", JSON.stringify(loads));
    renderLoads();

    // Clear inputs
    document.getElementById("ticketNumber").value = "";
    document.getElementById("customer").value = "";
    document.getElementById("rig").value = "";
    document.getElementById("lease").value = "";
    document.getElementById("price").value = "";
    document.getElementById("overnights").value = "";
  }

  function renderLoads() {
    const container = document.getElementById("loadList");
    container.innerHTML = "";
    const userLoads = loads[currentUser] || [];
    userLoads.forEach(load => {
      const div = document.createElement("div");
      div.className = "load-item";
      div.innerHTML = `
        <strong>Ticket:</strong> ${load.t} | <strong>Customer:</strong> ${load.c}<br/>
        Rig: ${load.r} | Lease: ${load.l}<br/>
        Price: $${load.p.toFixed(2)} | Overnights: ${load.o}<br/>
        <button onclick="editLoad(${load.id})">Edit</button>
        <button onclick="deleteLoad(${load.id})" style="background:#e33;">Delete</button>
      `;
      container.appendChild(div);
    });
  }

  function editLoad(id) {
    const userLoads = loads[currentUser] || [];
    const load = userLoads.find(l => l.id === id);
    if(!load) return alert("Load not found.");

    document.getElementById("ticketNumber").value = load.t;
    document.getElementById("customer").value = load.c;
    document.getElementById("rig").value = load.r;
    document.getElementById("lease").value = load.l;
    document.getElementById("price").value = load.p;
    document.getElementById("overnights").value = load.o;

    // Remove original load so it can be replaced on save
    loads[currentUser] = userLoads.filter(l => l.id !== id);
    localStorage.setItem("loads", JSON.stringify(loads));
    renderLoads();
  }

  function deleteLoad(id) {
    const userLoads = loads[currentUser] || [];
    loads[currentUser] = userLoads.filter(l => l.id !== id);
    localStorage.setItem("loads", JSON.stringify(loads));
    renderLoads();
  }

  // --- PDF FORM GENERATION ---
  function generateForm() {
    const userLoads = loads[currentUser] || [];
    if(userLoads.length === 0) {
      alert("No loads to generate form.");
      return;
    }

    let totalPrice = 0;
    let totalOvernights = 0;

    const formDetails = document.getElementById("formDetails");
    formDetails.innerHTML = "<ul>" + userLoads.map(l =>
      `<li>Ticket: ${l.t} | Price: $${l.p.toFixed(2)} | Overnights: ${l.o}</li>`
    ).join("") + "</ul>";

    userLoads.forEach(l => {
      totalPrice += l.p;
      totalOvernights += l.o;
    });

    formDetails.innerHTML += `
      <p><strong>Total Price:</strong> $${totalPrice.toFixed(2)}</p>
      <p><strong>Total Overnights:</strong> ${totalOvernights}</p>
    `;

    document.getElementById("totalsForm").classList.remove("hidden");
  }

  async function sendForm() {
    const { jsPDF } = window.jspdf;
    const userLoads = loads[currentUser] || [];
    if(userLoads.length === 0) return alert("No loads to export.");

    const doc = new jsPDF();
    let y = 10;
    doc.setFontSize(14);
    doc.text("FleetBord Load Summary", 10, y);
    y += 10;
    doc.setFontSize(12);

    userLoads.forEach((load, i) => {
      const line = `${i+1}. Ticket: ${load.t}, Customer: ${load.c}, Price: $${load.p.toFixed(2)}, Overnights: ${load.o}`;
      doc.text(line, 10, y);
      y += 8;
    });

    const totalPrice = userLoads.reduce((acc, l) => acc + l.p, 0);
    const totalOvernights = userLoads.reduce((acc, l) => acc + l.o, 0);

    y += 10;
    doc.text(`Total Price: $${totalPrice.toFixed(2)}`, 10, y);
    y += 8;
    doc.text(`Total Overnights: ${totalOvernights}`, 10, y);

    doc.save(`FleetBord_${currentUser}_Loads.pdf`);
  }

  // --- MESSAGING ---
  function renderMessages() {
    const msgList = document.getElementById("messageList");
    msgList.innerHTML = "";
    const relevant = messages.filter(
      m => m.to.includes(currentUser) || m.from === currentUser || m.to.includes("All")
    );
    relevant.reverse().forEach(m => {
      const div = document.createElement("div");
      div.className = "message-item";
      div.innerHTML = `
        <strong>${m.from}</strong> â†’ ${m.to.join(", ")}<br/>
        ${m.text} <small>(${m.timestamp})</small>
      `;
      msgList.appendChild(div);
    });
  }

  function populateRecipientList() {
    const select = document.getElementById("recipientSelect");
    select.innerHTML = "";
    for(const username in users) {
      if(username !== currentUser) {
        const opt = document.createElement("option");
        opt.value = username;
        opt.textContent = username;
        select.appendChild(opt);
      }
    }
    if(currentUser !== adminUsername
    if(currentUser !== adminUsername) {
      const adminOpt = document.createElement("option");
      adminOpt.value = adminUsername;
      adminOpt.textContent = adminUsername + " (Admin)";
      select.appendChild(adminOpt);
    }
  }

  function sendMessage() {
    const recipients = Array.from(document.getElementById("recipientSelect").selectedOptions).map(opt => opt.value);
    const text = document.getElementById("messageText").value.trim();
    if(recipients.length === 0 || !text) {
      alert("Please enter a message and select recipients.");
      return;
    }
    const now = new Date();
    const timestamp = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const newMsg = {
      from: currentUser,
      to: recipients,
      text,
      timestamp
    };
    messages.push(newMsg);
    localStorage.setItem("messages", JSON.stringify(messages));
    document.getElementById("messageText").value = "";
    renderMessages();
  }

  // Initialize app
  showPanel("login");
</script>

</body>
</html>
