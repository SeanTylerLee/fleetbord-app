<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="styles.css" />
  <title>Driver Panel</title>
</head>
<body>
  <header><img src="header.jpg" class="header-img" alt="Header"></header>
  <main class="container">
    <h2>Driver: Assigned Loads</h2>
    <div id="loadList"></div>
    <button onclick="logout()">Log Out</button>
  </main>

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== "driver") {
      alert("Access denied");
      window.location.href = "index.html";
    }

    const dispatchKey = "dispatches";
    const fileKey = "driverFiles";

    function loadDispatches() {
      return JSON.parse(localStorage.getItem(dispatchKey) || "[]");
    }

    function saveDispatches(data) {
      localStorage.setItem(dispatchKey, JSON.stringify(data));
    }

    function renderLoads() {
      const dispatches = loadDispatches();
      const container = document.getElementById("loadList");
      container.innerHTML = "";

      const assigned = dispatches.filter(d => d.drivers.includes(user.username));

      assigned.forEach((load, index) => {
        const status = load.status?.[user.username] || {};
        const accepted = status.accepted ? "âœ… Accepted" : "";
        const loaded = status.loaded ? "ðŸš› Loaded" : "";
        const unloaded = status.unloaded ? "ðŸ“¦ Unloaded" : "";
        const timestamp = status.timestamps || {};

        const otherDrivers = load.drivers.filter(name => name !== user.username);

        const loadId = `${load.customer}_${index}`;

        container.innerHTML += `
          <div style="border:1px solid #ccc;padding:10px;margin-bottom:15px;border-radius:10px;">
            <strong>${load.customer}</strong><br/>
            ${load.pickup} â†’ ${load.delivery}<br/>
            Pickup: ${load.pickupTime}<br/>
            Delivery: ${load.deliveryTime}<br/>
            Notes: ${load.notes}<br/>
            <small>Also assigned: ${otherDrivers.join(", ") || "None"}</small><br/><br/>

            <div>${accepted} ${loaded} ${unloaded}</div>
            <button onclick="acceptLoad(${index})" ${status.accepted ? "disabled" : ""}>Accept</button>
            <button onclick="markLoaded(${index})" ${!status.accepted || status.loaded ? "disabled" : ""}>Mark Loaded</button>
            <button onclick="markUnloaded(${index})" ${!status.loaded || status.unloaded ? "disabled" : ""}>Mark Unloaded</button><br/><br/>

            <label>Upload Ticket Photos:</label>
            <input type="file" accept="image/*" multiple onchange="saveFiles(event, '${loadId}')" /><br/>
            <div id="preview-${loadId}"></div>

            ${timestamp.accepted ? `<small>Accepted: ${timestamp.accepted}</small><br/>` : ""}
            ${timestamp.loaded ? `<small>Loaded: ${timestamp.loaded}</small><br/>` : ""}
            ${timestamp.unloaded ? `<small>Unloaded: ${timestamp.unloaded}</small><br/>` : ""}
          </div>
        `;

        showPreview(loadId);
      });
    }

    function acceptLoad(i) {
      const dispatches = loadDispatches();
      const dispatch = dispatches[i];
      dispatch.status = dispatch.status || {};
      dispatch.status[user.username] = dispatch.status[user.username] || {};
      dispatch.status[user.username].accepted = true;
      dispatch.status[user.username].timestamps = dispatch.status[user.username].timestamps || {};
      dispatch.status[user.username].timestamps.accepted = new Date().toLocaleString();
      saveDispatches(dispatches);
      renderLoads();
    }

    function markLoaded(i) {
      const dispatches = loadDispatches();
      const dispatch = dispatches[i];
      dispatch.status = dispatch.status || {};
      dispatch.status[user.username] = dispatch.status[user.username] || {};
      dispatch.status[user.username].loaded = true;
      dispatch.status[user.username].timestamps = dispatch.status[user.username].timestamps || {};
      dispatch.status[user.username].timestamps.loaded = new Date().toLocaleString();
      saveDispatches(dispatches);
      renderLoads();
    }

    function markUnloaded(i) {
      const dispatches = loadDispatches();
      const dispatch = dispatches[i];
      dispatch.status = dispatch.status || {};
      dispatch.status[user.username] = dispatch.status[user.username] || {};
      dispatch.status[user.username].unloaded = true;
      dispatch.status[user.username].timestamps = dispatch.status[user.username].timestamps || {};
      dispatch.status[user.username].timestamps.unloaded = new Date().toLocaleString();
      saveDispatches(dispatches);
      renderLoads();
    }

    function saveFiles(event, loadId) {
      const files = event.target.files;
      if (!files.length) return;
      const previews = [];
      const maxFiles = 5;

      const store = JSON.parse(localStorage.getItem(fileKey) || "{}");
      store[loadId] = store[loadId] || [];

      if (store[loadId].length + files.length > maxFiles) {
        alert("You can only upload up to 5 images per load.");
        return;
      }

      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          store[loadId].push(e.target.result);
          localStorage.setItem(fileKey, JSON.stringify(store));
          showPreview(loadId);
        };
        reader.readAsDataURL(file);
      });
    }

    function showPreview(loadId) {
      const div = document.getElementById(`preview-${loadId}`);
      const store = JSON.parse(localStorage.getItem(fileKey) || "{}");
      const imgs = store[loadId] || [];
      div.innerHTML = imgs.map(img => `<img src="${img}" style="width:80px;height:auto;margin:3px;border-radius:5px;">`).join("");
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    renderLoads();
  </script>
</body>
</html>