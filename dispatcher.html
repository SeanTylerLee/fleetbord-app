<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dispatcher Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="header"><img src="images/header.jpg" alt="Header" /></div>
  <div class="container">
    <button onclick="goBack()">← Back</button>
    <h2>Dispatcher Panel</h2>

    <h3>Create Dispatch</h3>
    <form id="dispatchForm">
      <input placeholder="Customer" required id="customer" />
      <input placeholder="Rate" required id="rate" />
      <input placeholder="Fuel" required id="fuel" />
      <input placeholder="Salesman" required id="salesman" />
      <input type="datetime-local" required id="loadTime" />
      <input placeholder="Load Location (URL or coordinates)" required id="loadLoc" />
      <input type="datetime-local" required id="unloadTime" />
      <input placeholder="Unload Location" required id="unloadLoc" />
      <textarea placeholder="Notes..." id="notes"></textarea>
      <input type="file" id="dispatchFile" />
      <label>Select Drivers:</label>
      <div id="driverList"></div>
      <button type="submit">Dispatch</button>
    </form>

    <h3>Manage Users</h3>
    <div>
      <input placeholder="Username" id="newUser" />
      <input placeholder="Password" id="newPass" />
      <select id="newRole">
        <option value="driver">Driver</option>
        <option value="office">Office</option>
        <option value="mechanic">Mechanic</option>
      </select>
      <button onclick="createUser()">Add User</button>
    </div>
    <ul id="userList"></ul>
  </div>
  <script>
    const users = JSON.parse(localStorage.getItem("users"));
    const driverList = document.getElementById("driverList");
    const userList = document.getElementById("userList");

    function populateDrivers() {
      driverList.innerHTML = '';
      users.filter(u => u.role === "driver").forEach(u => {
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = u.username;
        cb.id = "drv_" + u.username;
        const label = document.createElement("label");
        label.textContent = u.username;
        label.htmlFor = cb.id;
        driverList.appendChild(cb);
        driverList.appendChild(label);
        driverList.appendChild(document.createElement("br"));
      });
    }

    function createUser() {
      const uname = document.getElementById("newUser").value;
      const pass = document.getElementById("newPass").value;
      const role = document.getElementById("newRole").value;
      if (!uname || !pass) return alert("Missing fields");
      users.push({ username: uname, password: pass, role });
      localStorage.setItem("users", JSON.stringify(users));
      loadUsers();
      populateDrivers();
    }

    function loadUsers() {
      userList.innerHTML = '';
      users.forEach((u, i) => {
        const li = document.createElement("li");
        li.textContent = `${u.username} (${u.role})`;
        if (u.username !== "001") {
          const del = document.createElement("button");
          del.textContent = "❌";
          del.onclick = () => {
            users.splice(i, 1);
            localStorage.setItem("users", JSON.stringify(users));
            loadUsers();
            populateDrivers();
          };
          li.appendChild(del);
        }
        userList.appendChild(li);
      });
    }

    document.getElementById("dispatchForm").onsubmit = (e) => {
      e.preventDefault();
      const load = {
        customer: customer.value,
        rate: rate.value,
        fuel: fuel.value,
        salesman: salesman.value,
        loadTime: loadTime.value,
        loadLoc: loadLoc.value,
        unloadTime: unloadTime.value,
        unloadLoc: unloadLoc.value,
        notes: notes.value,
        file: dispatchFile.files[0]?.name || null,
        drivers: Array.from(document.querySelectorAll("#driverList input:checked")).map(cb => cb.value),
        status: {}
      };
      load.drivers.forEach(d => {
        load.status[d] = { accepted: false, loaded: false, unloaded: false };
      });
      const dispatches = JSON.parse(localStorage.getItem("dispatches") || "[]");
      dispatches.push(load);
      localStorage.setItem("dispatches", JSON.stringify(dispatches));
      alert("Load dispatched!");
      e.target.reset();
    };

    function goBack() {
      window.location.href = "index.html";
    }

    loadUsers();
    populateDrivers();
  </script>
</body>
</html>