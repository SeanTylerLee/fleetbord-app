<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="stylesheet" href="styles.css" />
  <title>Dispatcher Panel</title>
</head>
<body>
  <header><img src="header.jpg" class="header-img" alt="Header"></header>
  <main class="container">
    <h2>Dispatcher: Create Dispatch</h2>

    <form id="dispatchForm">
      <input type="text" id="customer" placeholder="Customer" required />
      <input type="text" id="pickup" placeholder="Pickup Location" required />
      <input type="text" id="delivery" placeholder="Delivery Location" required />
      <input type="datetime-local" id="pickupTime" required />
      <input type="datetime-local" id="deliveryTime" required />
      <textarea id="notes" placeholder="Notes"></textarea>

      <label>Select Drivers:</label>
      <div id="driverList"></div>

      <button type="submit">Dispatch Load</button>
    </form>

    <h3>All Dispatches</h3>
    <div id="dispatchList"></div>

    <button onclick="logout()">Log Out</button>
  </main>

  <script>
    const dispatchKey = "dispatches";

    function loadUsers() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      return users.filter(u => u.role === "driver");
    }

    function loadDispatches() {
      return JSON.parse(localStorage.getItem(dispatchKey) || "[]");
    }

    function saveDispatches(data) {
      localStorage.setItem(dispatchKey, JSON.stringify(data));
    }

    function renderDrivers() {
      const drivers = loadUsers();
      const div = document.getElementById("driverList");
      div.innerHTML = "";

      drivers.forEach(driver => {
        const box = document.createElement("div");
        box.innerHTML = `
          <label>
            <input type="checkbox" value="${driver.username}" />
            ${driver.username}
          </label>
        `;
        div.appendChild(box);
      });
    }

    function renderDispatches() {
      const dispatches = loadDispatches();
      const div = document.getElementById("dispatchList");
      div.innerHTML = "";

      dispatches.forEach((d, index) => {
        div.innerHTML += `
          <div style="border:1px solid #ccc;padding:10px;border-radius:10px;margin-bottom:10px;">
            <strong>${d.customer}</strong><br/>
            ${d.pickup} â†’ ${d.delivery}<br/>
            Pickup: ${d.pickupTime}<br/>
            Delivery: ${d.deliveryTime}<br/>
            Assigned: ${d.drivers.join(", ")}<br/>
            Notes: ${d.notes}
          </div>
        `;
      });
    }

    document.getElementById("dispatchForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const drivers = Array.from(document.querySelectorAll('#driverList input[type="checkbox"]:checked')).map(cb => cb.value);
      if (drivers.length === 0) return alert("Select at least one driver");

      const newDispatch = {
        customer: document.getElementById("customer").value,
        pickup: document.getElementById("pickup").value,
        delivery: document.getElementById("delivery").value,
        pickupTime: document.getElementById("pickupTime").value,
        deliveryTime: document.getElementById("deliveryTime").value,
        notes: document.getElementById("notes").value,
        drivers,
        status: {} // will hold driver status: accepted, loaded, etc.
      };

      const existing = loadDispatches();
      existing.push(newDispatch);
      saveDispatches(existing);
      renderDispatches();
      this.reset();
    });

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    const currentUser = JSON.parse(localStorage.getItem("user"));
    if (!currentUser || currentUser.role !== "dispatcher") {
      alert("Access denied");
      window.location.href = "index.html";
    } else {
      renderDrivers();
      renderDispatches();
    }
  </script>
</body>
</html>