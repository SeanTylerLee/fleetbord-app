<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Fleetbord - Messages</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- Top Header -->
  <header>
    <a href="index.html" class="back-button">
      <svg class="back-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 22" fill="none">
        <path d="M11 1L2 11L11 21" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back
    </a>
  </header>

  <!-- Banner -->
  <img src="header.png" alt="Top Banner" class="top-image" />

  <!-- Main Content -->
  <main>
    <!-- Conversations List -->
    <div class="card">
      <h2>Conversations</h2>
      <input type="text" id="searchUser" placeholder="Search or start new conversation" />
      <ul id="conversationsList" style="list-style: none; padding-left: 0; margin-top: 1rem;"></ul>
      <button id="startNewBtn" style="margin-top: 1rem;">Start New Conversation</button>
    </div>

    <!-- Selected Conversation -->
    <div class="card" id="conversationDetail" style="display:none;">
      <h2 id="conversationWith"></h2>
      <div id="messagesContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; border-radius: 8px; background: #fff;"></div>

      <form id="messageForm" style="margin-top: 10px; display: flex; gap: 8px;">
        <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" style="flex-grow: 1; padding: 8px; border-radius: 8px; border: 1px solid #ccc;" required />
        <button type="submit" style="padding: 8px 12px; border-radius: 8px; background-color: #007aff; color: white; border: none;">Send</button>
      </form>
      <button id="backToConvos" style="margin-top: 10px;">Back to Conversations</button>
    </div>
  </main>

  <!-- Bottom Tab Bar -->
  <nav class="tab-bar">
    <a href="index.html" class="tab-button">Home</a>
    <a href="loads.html" class="tab-button">Loads</a>
    <a href="messages.html" class="tab-button active">Messages</a>
    <a href="settings.html" class="tab-button">Settings</a>
  </nav>

  <script>
    // Simple in-memory conversations and messages (use localStorage for persistence)
    let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
    const loggedInUser = localStorage.getItem('fleetbordLoggedInUser') || 'You';

    const conversationsList = document.getElementById('conversationsList');
    const conversationDetail = document.getElementById('conversationDetail');
    const conversationWith = document.getElementById('conversationWith');
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const backToConvosBtn = document.getElementById('backToConvos');
    const startNewBtn = document.getElementById('startNewBtn');
    const searchUserInput = document.getElementById('searchUser');

    let currentConversationId = null;

    function saveConversations() {
      localStorage.setItem('conversations', JSON.stringify(conversations));
    }

    function renderConversations(filter = '') {
      conversationsList.innerHTML = '';
      const filteredConvos = conversations.filter(c => c.with.toLowerCase().includes(filter.toLowerCase()));

      if (filteredConvos.length === 0) {
        conversationsList.innerHTML = '<li>No conversations found.</li>';
        return;
      }

      filteredConvos.forEach((conv, index) => {
        const li = document.createElement('li');
        li.style.padding = '10px';
        li.style.borderBottom = '1px solid #ddd';
        li.style.cursor = 'pointer';
        li.textContent = conv.with;
        li.addEventListener('click', () => openConversation(index));
        conversationsList.appendChild(li);
      });
    }

    function openConversation(index) {
      currentConversationId = index;
      const conv = conversations[index];
      conversationWith.textContent = `Conversation with ${conv.with}`;
      renderMessages(conv.messages);
      conversationDetail.style.display = 'block';
      conversationsList.parentElement.style.display = 'none';
      startNewBtn.style.display = 'none';
    }

    function renderMessages(messages) {
      messagesContainer.innerHTML = '';
      messages.forEach(msg => {
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.style.textAlign = msg.sender === loggedInUser ? 'right' : 'left';

        const bubble = document.createElement('div');
        bubble.style.display = 'inline-block';
        bubble.style.padding = '8px 12px';
        bubble.style.borderRadius = '16px';
        bubble.style.background = msg.sender === loggedInUser ? '#007aff' : '#e5e5ea';
        bubble.style.color = msg.sender === loggedInUser ? '#fff' : '#000';
        bubble.style.maxWidth = '70%';
        bubble.textContent = msg.text;

        const timestamp = document.createElement('div');
        timestamp.style.fontSize = '10px';
        timestamp.style.color = '#666';
        timestamp.textContent = new Date(msg.time).toLocaleString();

        div.appendChild(bubble);
        div.appendChild(timestamp);
        messagesContainer.appendChild(div);
      });
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    messageForm.addEventListener('submit', e => {
      e.preventDefault();
      const text = messageInput.value.trim();
      if (!text) return;

      const newMsg = {
        sender: loggedInUser,
        text,
        time: new Date().toISOString()
      };

      conversations[currentConversationId].messages.push(newMsg);
      saveConversations();
      renderMessages(conversations[currentConversationId].messages);
      messageInput.value = '';
    });

    backToConvosBtn.addEventListener('click', () => {
      conversationDetail.style.display = 'none';
      conversationsList.parentElement.style.display = 'block';
      startNewBtn.style.display = 'inline-block';
      currentConversationId = null;
      renderConversations();
    });

    startNewBtn.addEventListener('click', () => {
      const newUser = prompt('Enter username to start conversation with:');
      if (newUser && newUser.trim()) {
        const exists = conversations.findIndex(c => c.with.toLowerCase() === newUser.toLowerCase());
        if (exists !== -1) {
          openConversation(exists);
        } else {
          conversations.push({ with: newUser.trim(), messages: [] });
          saveConversations();
          renderConversations();
        }
      }
    });

    searchUserInput.addEventListener('input', () => {
      renderConversations(searchUserInput.value);
    });

    // Initial render
    renderConversations();
  </script>

</body>
</html>