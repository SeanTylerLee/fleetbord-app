<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
  <title>Permit Route Scanner</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f9f9f9;
      color: #333;
    }

    header {
      background: #007aff;
      color: white;
      padding: 1rem;
      text-align: center;
      font-weight: bold;
    }

    main {
      padding: 1rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    input[type="file"] {
      display: block;
      margin: 1rem 0;
    }

    #map {
      height: 400px;
      width: 100%;
      border-radius: 12px;
      margin-top: 1rem;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

  <header>Oversize Permit Route Scanner</header>

  <main>
    <div class="card">
      <p>Select or take a picture of the permit with driving directions:</p>
      <input type="file" id="imageInput" accept="image/*" />
      <button onclick="processImage()">Scan Directions</button>
      <p id="status"></p>
    </div>

    <div class="card" style="display: none;" id="mapCard">
      <h3>Route Preview</h3>
      <div id="map"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const imageInput = document.getElementById('imageInput');
    const status = document.getElementById('status');
    const mapCard = document.getElementById('mapCard');
    const ORS_API_KEY = '5b3ce3597851110001cf6248c217e0b44f394c4e9750235cfa09dee0'; // Replace with your free OpenRouteService key

    async function processImage() {
      const file = imageInput.files[0];
      if (!file) return alert("Please upload a photo first.");

      status.textContent = "Scanning image for text...";
      const { data: { text } } = await Tesseract.recognize(file, 'eng');
      status.textContent = "Parsing addresses...";

      const addresses = extractAddresses(text);
      if (addresses.length < 2) {
        status.textContent = "Could not find enough addresses. Try a clearer image.";
        return;
      }

      status.textContent = "Found " + addresses.length + " location(s), building map...";
      showRouteOnMap(addresses);
    }

    function extractAddresses(text) {
      const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
      const addressPattern = /[0-9]{1,5} .+/;
      return lines.filter(line => addressPattern.test(line)).slice(0, 10); // up to 10 points
    }

    async function showRouteOnMap(addresses) {
      mapCard.style.display = 'block';

      const coords = [];
      for (let addr of addresses) {
        const res = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(addr)}`);
        const json = await res.json();
        if (json.features.length > 0) {
          const [lon, lat] = json.features[0].geometry.coordinates;
          coords.push([lat, lon]);
        }
      }

      if (coords.length < 2) {
        status.textContent = "Unable to geocode enough addresses.";
        return;
      }

      const map = L.map('map').setView(coords[0], 8);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      coords.forEach((coord, i) => {
        L.marker(coord).addTo(map).bindPopup(`Stop ${i + 1}`);
      });

      fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
        method: 'POST',
        headers: {
          'Authorization': ORS_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          coordinates: coords.map(c => [c[1], c[0]])
        })
      })
      .then(res => res.json())
      .then(data => {
        const routeLayer = L.geoJSON(data).addTo(map);
        map.fitBounds(routeLayer.getBounds());
        status.textContent = "Route loaded.";
      })
      .catch(() => status.textContent = "Error building route.");
    }
  </script>
</body>
</html>