<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Dispatch</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      background: var(--bg, #fff);
      color: var(--text, #000);
    }
    header img {
      width: 100%;
      display: block;
    }
    .container {
      padding: 1rem;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .btn {
      margin-top: 15px;
      padding: 12px;
      width: 100%;
      background: #007aff;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
    }
    .hidden { display: none; }
    .dispatch-card {
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      background: #f9f9f9;
    }
  </style>
</head>
<body>
  <header><img src="header.jpg" alt="Header" /></header>
  <div class="container">
    <h2>Dispatch Center</h2>

    <!-- Only admins can see the dispatch form -->
    <div id="adminSection" class="hidden">
      <label>Select Load to Dispatch:</label>
      <select id="loadSelect">
        <option value="">-- Choose a Load --</option>
      </select>

      <label>Select Driver(s):</label>
      <div id="driverList"></div>

      <label>Attach File or Photo:</label>
      <input type="file" id="dispatchAttachment" accept="image/*,.pdf" />

      <button class="btn" onclick="dispatchLoad()">üöõ Send Dispatch</button>
    </div>

    <!-- All users see their assigned dispatches -->
    <div>
      <h3>Your Assigned Dispatches</h3>
      <div id="dispatchList"></div>
    </div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem("currentUser") || "{}");
    const users = JSON.parse(localStorage.getItem("users") || "[]");
    const allDispatches = JSON.parse(localStorage.getItem("dispatches") || "[]");
    const savedLoads = JSON.parse(localStorage.getItem("loads") || "[]");
    const dispatchList = document.getElementById("dispatchList");

    // Admin Section
    const adminSection = document.getElementById("adminSection");
    const loadSelect = document.getElementById("loadSelect");
    const driverList = document.getElementById("driverList");

    if (user.role === "admin") {
      adminSection.classList.remove("hidden");

      // Populate loads dropdown
      savedLoads.forEach((load, idx) => {
        const option = document.createElement("option");
        option.value = idx;
        option.textContent = `${load.customer} | ${load.loadLocation} ‚ûî ${load.unloadLocation}`;
        loadSelect.appendChild(option);
      });

      // Populate driver checkboxes
      users.filter(u => u.role === "driver").forEach(driver => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${driver.username}" /> ${driver.username}`;
        driverList.appendChild(label);
        driverList.appendChild(document.createElement("br"));
      });
    }

    function dispatchLoad() {
      const selectedIndex = loadSelect.value;
      if (selectedIndex === "") return alert("Please select a load.");
      const selectedDrivers = Array.from(driverList.querySelectorAll("input:checked")).map(cb => cb.value);
      if (selectedDrivers.length === 0) return alert("Please select at least one driver.");

      const baseLoad = savedLoads[selectedIndex];
      const fileInput = document.getElementById("dispatchAttachment");
      const file = fileInput.files[0];

      const dispatch = {
        ...baseLoad,
        id: Date.now(),
        drivers: selectedDrivers,
        accepted: [],
        attachment: ""
      };

      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          dispatch.attachment = e.target.result;
          saveDispatch(dispatch);
        };
        reader.readAsDataURL(file);
      } else {
        saveDispatch(dispatch);
      }
    }

    function saveDispatch(dispatch) {
      const all = JSON.parse(localStorage.getItem("dispatches") || "[]");
      all.push(dispatch);
      localStorage.setItem("dispatches", JSON.stringify(all));
      alert("‚úÖ Load dispatched!");
      window.location.reload();
    }

    function loadDispatches() {
      dispatchList.innerHTML = "";
      const relevant = allDispatches.filter(d => d.drivers.includes(user.username));
      relevant.forEach(d => {
        const div = document.createElement("div");
        div.className = "dispatch-card";
        div.innerHTML = `
          <strong>Customer:</strong> ${d.customer}<br>
          <strong>Rate:</strong> $${d.rate} | <strong>Fuel:</strong> $${d.surcharge}<br>
          <strong>Load:</strong> ${d.loadLocation}<br>
          <strong>Unload:</strong> ${d.unloadLocation}<br>
          <strong>Salesman:</strong> ${d.salesman}<br>
          <strong>Dispatch Date:</strong> ${d.dispatchDate}<br>
          <strong>Due Date:</strong> ${d.dueDate}<br>
          <strong>Notes:</strong> ${d.notes}<br>
          ${d.mapPin ? `<a href="${d.mapPin}" target="_blank">üìç Open Map</a><br>` : ""}
          ${d.attachment ? `<a href="${d.attachment}" download="dispatch-file">üìé Download Attachment</a><br>` : ""}
          <strong>Drivers:</strong> ${d.drivers.join(", ")}<br>
          <strong>Accepted:</strong> ${d.accepted.length > 0 ? d.accepted.join(", ") : "None"}
        `;

        if (!d.accepted.includes(user.username)) {
          const acceptBtn = document.createElement("button");
          acceptBtn.className = "btn";
          acceptBtn.textContent = "Accept Load";
          acceptBtn.onclick = () => {
            d.accepted.push(user.username);
            const all = JSON.parse(localStorage.getItem("dispatches") || "[]");
            const i = all.findIndex(x => x.id === d.id);
            if (i !== -1) {
              all[i] = d;
              localStorage.setItem("dispatches", JSON.stringify(all));
              loadDispatches();
            }
          };
          div.appendChild(acceptBtn);
        }

        dispatchList.appendChild(div);
      });
    }

    loadDispatches();

    // Theme check
    if (localStorage.getItem("darkMode") === "true") {
      document.documentElement.classList.add("dark-mode");
    }
  </script>
</body>
</html>