<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Loads | Fleetbord</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Load Records</h1>
    <a href="dashboard.html" class="nav-button">← Back</a>
  </header>

  <main>
    <form id="loadForm">
      <h3>Add/Edit Load</h3>
      <input type="hidden" id="loadId">
      <label>Date:</label><br><input type="date" id="date" required><br><br>
      <label>Ticket #:</label><br><input type="text" id="ticket" required><br><br>
      <label>Customer:</label><br><input type="text" id="customer" required><br><br>
      <label>Rig:</label><br><input type="text" id="rig" required><br><br>
      <label>Lease:</label><br><input type="text" id="lease" required><br><br>
      <label>Price:</label><br><input type="number" id="price" required><br><br>
      <label>Overnights:</label><br><input type="number" id="overnights" required><br><br>
      <label>Attach Photo (optional):</label><br><input type="file" id="loadPhoto"><br><br>
      <button type="submit" class="nav-button">Save Load</button>
    </form>

    <hr style="margin: 2em 0;">

    <h3>Your Loads</h3>
    <div id="loadList"></div>
  </main>

  <script>
    const username = localStorage.getItem('username');
    if (!username) window.location.href = 'index.html';

    const form = document.getElementById('loadForm');
    const loadList = document.getElementById('loadList');

    async function loadLoads() {
      const res = await fetch('/loads?user=' + username);
      const data = await res.json();
      loadList.innerHTML = data.map(load => `
        <div style="margin-bottom:1em; padding:1em; background:var(--card); border-radius:0.5em;">
          <strong>${load.date}</strong> — Ticket #${load.ticket}<br>
          ${load.customer} / ${load.rig} / ${load.lease}<br>
          $${load.price} | ${load.overnights} overnight(s)<br>
          ${load.photo ? `<img src="/uploads/${load.photo}" style="max-width:100%; margin-top:0.5em;">` : ''}
          <div style="margin-top:0.5em;">
            <button onclick="editLoad(${load.id})" class="nav-button">Edit</button>
            <button onclick="deleteLoad(${load.id})" class="nav-button logout">Delete</button>
          </div>
        </div>
      `).join('');
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData();
      const id = document.getElementById('loadId').value;
      formData.append('user', username);
      formData.append('date', document.getElementById('date').value);
      formData.append('ticket', document.getElementById('ticket').value);
      formData.append('customer', document.getElementById('customer').value);
      formData.append('rig', document.getElementById('rig').value);
      formData.append('lease', document.getElementById('lease').value);
      formData.append('price', document.getElementById('price').value);
      formData.append('overnights', document.getElementById('overnights').value);
      const photo = document.getElementById('loadPhoto').files[0];
      if (photo) formData.append('photo', photo);

      await fetch(id ? `/loads/${id}` : '/loads', {
        method: id ? 'PUT' : 'POST',
        body: formData
      });

      form.reset();
      document.getElementById('loadId').value = '';
      loadLoads();
    };

    async function editLoad(id) {
      const res = await fetch(`/loads/${id}`);
      const load = await res.json();
      document.getElementById('loadId').value = load.id;
      document.getElementById('date').value = load.date;
      document.getElementById('ticket').value = load.ticket;
      document.getElementById('customer').value = load.customer;
      document.getElementById('rig').value = load.rig;
      document.getElementById('lease').value = load.lease;
      document.getElementById('price').value = load.price;
      document.getElementById('overnights').value = load.overnights;
    }

    async function deleteLoad(id) {
      if (!confirm("Are you sure?")) return;
      await fetch(`/loads/${id}`, { method: 'DELETE' });
      loadLoads();
    }

    loadLoads();
  </script>
</body>
</html>